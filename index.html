<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Kopkar AKM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="pb-20">

    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-white p-1 rounded h-8 w-8 flex items-center justify-center">
                    <img src="https://i.ibb.co.com/WvTwLMn5/image-1.png" alt="Logo" class="h-full w-auto">
                </div>
                <h1 class="font-bold text-lg">Panel Kendali Kopkar AKM</h1>
            </div>
            <div class="flex gap-2">
                <button onclick="loadAllData()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> Segarkan
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 md:p-6 space-y-6">
        
        <!-- Filter Bar -->
        <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-wrap gap-4 items-center">
            <div class="flex items-center gap-2">
                <i data-lucide="filter" class="w-4 h-4 text-slate-400"></i>
                <span class="text-xs font-bold text-slate-500 uppercase">Filter:</span>
            </div>
            <select id="filter-lokasi" onchange="applyFilters()" class="text-xs font-semibold p-2 rounded-lg border bg-slate-50 outline-none focus:ring-2 focus:ring-emerald-500">
                <option value="Semua">Semua Lokasi</option>
                <option>Kelanis</option><option>Dahai</option><option>KM 82</option><option>Kantor Tanjung</option>
            </select>
            <select id="filter-masa" onchange="applyFilters()" class="text-xs font-semibold p-2 rounded-lg border bg-slate-50 outline-none focus:ring-2 focus:ring-emerald-500">
                <option value="Semua">Semua Masa Keanggotaan</option>
                <option value="<1 th">&lt; 1 th</option>
                <option value="1-5 th">1-5 th</option>
                <option value=">5 th">&gt; 5 th</option>
            </select>
        </div>

        <!-- Top Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Responden Aktif</p>
                <h3 class="text-4xl font-black text-slate-900 mt-1" id="stat-count">-</h3>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Indeks Kepuasan</p>
                <h3 class="text-4xl font-black text-emerald-600 mt-1" id="stat-avg">-%</h3>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 md:col-span-2">
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Status Strategis</p>
                <div class="flex items-center gap-2 mt-2">
                    <div id="status-dot" class="w-3 h-3 rounded-full bg-slate-200"></div>
                    <span id="status-text" class="font-bold text-slate-700">Menganalisis data...</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Radar Chart -->
            <div class="lg:col-span-2 bg-white p-6 rounded-3xl shadow-sm border border-slate-200 h-[450px] flex flex-col">
                <h4 class="font-bold text-slate-800 mb-4 text-xs uppercase tracking-widest flex items-center gap-2">
                    <i data-lucide="bar-chart-3" class="w-4 h-4"></i> Performa Berdasarkan Unit Bisnis
                </h4>
                <div class="flex-1 relative">
                    <canvas id="adminRadar"></canvas>
                </div>
            </div>

            <!-- Priority Actions -->
            <div class="bg-slate-900 text-white p-6 rounded-3xl shadow-xl flex flex-col h-[450px]">
                <h4 class="font-bold text-emerald-400 mb-4 flex items-center gap-2 text-xs uppercase tracking-widest">
                    <i data-lucide="list-checks" class="w-5 h-5"></i> Agenda Perbaikan (Skor < 3.5)
                </h4>
                <div id="action-list" class="space-y-3 overflow-y-auto pr-2 custom-scrollbar flex-1">
                    <p class="text-slate-500 italic text-xs">Sedang menghitung prioritas...</p>
                </div>
            </div>
        </div>

        <!-- Feedback Deep Analysis -->
        <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
            <div class="p-6 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
                <h4 class="font-bold text-slate-800 text-xs uppercase tracking-widest">Detail Aspirasi & Masukan Anggota</h4>
                <div class="text-[10px] text-slate-400 font-bold px-2 py-1 bg-white rounded border uppercase">Live Updates</div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-white text-slate-400 border-b border-slate-100 uppercase text-[9px] font-black tracking-widest">
                        <tr>
                            <th class="p-4">Identitas</th>
                            <th class="p-4">Skor</th>
                            <th class="p-4">Harapan Produk Baru</th>
                            <th class="p-4">Perbaikan Utama</th>
                            <th class="p-4">Saran SHU</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="divide-y divide-slate-50">
                        <!-- Data rows -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbymG6R-RW5C9oDkCFPyrSbYLL1oHlp7GlgSjQxW6kQDs22XEPLCQPpV_PBk8uNo43iU6Q/exec';
        let radarChart;
        let rawData = [];
        let dataHeaders = [];

        window.onload = () => {
            lucide.createIcons();
            loadAllData();
        };

        async function loadAllData() {
            const statusText = document.getElementById('status-text');
            try {
                const response = await fetch(`${scriptURL}?get=all&t=${Date.now()}`);
                const result = await response.json();
                
                if (!result.data) throw new Error("Format data tidak valid");

                dataHeaders = result.headers;
                rawData = result.data;
                
                applyFilters();
            } catch (e) {
                console.error(e);
                statusText.innerText = "Gagal memuat data dari Google Sheets";
                statusText.className = "font-bold text-red-500";
            }
        }

        function applyFilters() {
            const locFilter = document.getElementById('filter-lokasi').value;
            const masaFilter = document.getElementById('filter-masa').value;

            // Mapping index berdasarkan backend (Timestamp=0, NIK=1, Nama=2, Lokasi=3, Masa=4)
            const filtered = rawData.filter(r => {
                const matchLoc = locFilter === "Semua" || r[3] === locFilter;
                const matchMasa = masaFilter === "Semua" || r[4] === masaFilter;
                return matchLoc && matchMasa;
            }).reverse();

            updateUI(filtered);
        }

        function updateUI(rows) {
            updateStats(rows);
            updateTable(rows);
            updateCharts(rows);
            generateActions(rows);
        }

        function updateStats(rows) {
            if (rows.length === 0) {
                document.getElementById('stat-count').innerText = "0";
                document.getElementById('stat-avg').innerText = "0%";
                return;
            }

            const scoreIdx = dataHeaders.indexOf("Skor_Total");
            let total = 0;
            rows.forEach(r => total += (parseFloat(r[scoreIdx]) || 0));
            const avg = Math.round(total / rows.length);

            document.getElementById('stat-count').innerText = rows.length;
            document.getElementById('stat-avg').innerText = avg + "%";
            
            const statusText = document.getElementById('status-text');
            const statusDot = document.getElementById('status-dot');
            
            if (avg >= 80) {
                statusText.innerText = "Sangat Memuaskan";
                statusText.className = "font-bold text-emerald-600";
                statusDot.className = "w-3 h-3 rounded-full bg-emerald-500";
            } else if (avg >= 60) {
                statusText.innerText = "Kinerja Stabil (Perlu Pantauan)";
                statusText.className = "font-bold text-amber-600";
                statusDot.className = "w-3 h-3 rounded-full bg-amber-500";
            } else {
                statusText.innerText = "Tindakan Darurat Diperlukan";
                statusText.className = "font-bold text-red-600";
                statusDot.className = "w-3 h-3 rounded-full bg-red-500";
            }
        }

        function updateTable(rows) {
            const tbody = document.getElementById('table-body');
            const scoreIdx = dataHeaders.indexOf("Skor_Total");
            const harapanIdx = dataHeaders.indexOf("Harapan");
            const perbaikanIdx = dataHeaders.indexOf("Perbaikan");
            const shuIdx = dataHeaders.indexOf("Saran_SHU");

            if (rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-10 text-center text-slate-400">Tidak ada data untuk filter ini</td></tr>`;
                return;
            }

            tbody.innerHTML = rows.slice(0, 15).map(r => `
                <tr class="hover:bg-slate-50 transition">
                    <td class="p-4">
                        <div class="font-bold text-slate-800 leading-tight">${r[2] || 'Anonim'}</div>
                        <div class="text-[10px] text-slate-400 font-mono">NIK: ${r[1] || '-'} â€¢ ${r[3]}</div>
                    </td>
                    <td class="p-4">
                        <div class="px-2 py-1 rounded bg-slate-100 text-slate-700 font-black text-center text-xs w-12">${r[scoreIdx]}%</div>
                    </td>
                    <td class="p-4 text-xs text-slate-600 font-medium italic">${r[harapanIdx] || '-'}</td>
                    <td class="p-4 text-xs text-red-600 font-bold">${r[perbaikanIdx] || '-'}</td>
                    <td class="p-4 text-xs text-emerald-700 font-semibold">${r[shuIdx] || '-'}</td>
                </tr>
            `).join('');
        }

        function updateCharts(rows) {
            const getAvg = (start, end) => {
                let sum = 0, count = 0;
                rows.forEach(r => {
                    for (let i = start; i <= end; i++) {
                        let v = parseFloat(r[i]);
                        if (!isNaN(v) && v > 0) { sum += v; count++; }
                    }
                });
                return count > 0 ? (sum / count).toFixed(2) : 0;
            };

            // Mapping index sesuai backend.gs (GCG: 6-11, USP: 12-17, TRV: 18-21, RET: 22-27)
            const stats = [getAvg(6, 11), getAvg(12, 17), getAvg(18, 21), getAvg(22, 27)];

            const ctx = document.getElementById('adminRadar').getContext('2d');
            if (radarChart) radarChart.destroy();
            
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['GCG & Tata Kelola', 'Simpan Pinjam', 'Unit Travel', 'Ritel & Adamart'],
                    datasets: [{
                        label: 'Skor Kumulatif',
                        data: stats,
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        borderColor: '#059669',
                        pointBackgroundColor: '#059669',
                        borderWidth: 4,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0, max: 5,
                            ticks: { display: false, stepSize: 1 },
                            grid: { color: '#f1f5f9' },
                            pointLabels: { font: { size: 10, weight: '800' }, color: '#64748b' }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function generateActions(rows) {
            const list = document.getElementById('action-list');
            const actions = [];
            
            const getAvg = (start, end) => {
                let sum = 0, count = 0;
                rows.forEach(r => {
                    for (let i = start; i <= end; i++) {
                        let v = parseFloat(r[i]);
                        if (!isNaN(v) && v > 0) { sum += v; count++; }
                    }
                });
                return count > 0 ? sum / count : 5;
            };

            // Logika berdasarkan Blueprint Riset
            if (getAvg(6, 11) < 4) actions.push({ icon: "shield-alert", title: "Integritas & Transparansi", desc: "Perkuat keterbukaan laporan keuangan bulanan di portal anggota." });
            if (getAvg(12, 17) < 3.8) actions.push({ icon: "clock", title: "SLA Pinjaman", desc: "Tinjau birokrasi pencairan USP. Targetkan cair < 24 jam." });
            if (getAvg(18, 21) < 3.5) actions.push({ icon: "map", title: "Audit Travel", desc: "Banyak pengguna tidak puas dengan fasilitas hotel atau muthowif." });
            if (getAvg(22, 27) < 3.5) actions.push({ icon: "package", title: "Restock Adamart", desc: "Lakukan audit ketersediaan barang pokok secara mingguan." });

            if (actions.length === 0) {
                actions.push({ icon: "award", title: "Kinerja Prima", desc: "Pertahankan standar layanan saat ini. Fokus pada inovasi produk baru." });
            }

            list.innerHTML = actions.map(a => `
                <div class="bg-slate-800 p-4 rounded-2xl border-l-4 border-emerald-500 hover:bg-slate-700 transition cursor-default">
                    <div class="flex gap-3">
                        <i data-lucide="${a.icon}" class="w-5 h-5 text-emerald-400 shrink-0"></i>
                        <div>
                            <div class="font-bold text-white text-xs mb-1">${a.title}</div>
                            <div class="text-slate-400 text-[11px] leading-relaxed">${a.desc}</div>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }
    </script>
</body>
</html>
